<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tien Thuong</title>
    <link rel="icon" type="image/png" href="heart.png" />
    <link rel="stylesheet" href="./style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <!-- three.js import map -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
          "three/addons/controls/OrbitControls.js": "https://unpkg.com/three@0.152.2/examples/jsm/controls/OrbitControls.js",
          "three/examples/jsm/loaders/FontLoader.js": "https://unpkg.com/three@0.152.2/examples/jsm/loaders/FontLoader.js",
          "three/examples/jsm/geometries/TextGeometry.js": "https://unpkg.com/three@0.152.2/examples/jsm/geometries/TextGeometry.js"
        }
      }
    </script>

    <style>
      #image-input-container {
        display: none !important;
      }

      #qr-overlay {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        background: radial-gradient(ellipse at center, #0b0b1a 0%, #000 100%);
        z-index: 100000;
        color: #e0eaff;
        text-align: center;
        padding: 24px;
      }
      #qr-overlay .panel {
        background: rgba(20, 24, 48, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 16px;
        padding: 18px 18px 22px;
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(8px);
        max-width: 92vw;
      }
      #qr-box {
        margin: 10px auto 4px;
        padding: 10px;
        background: #fff;
        border-radius: 12px;
        display: inline-block;
      }
      #qr-link {
        word-break: break-all;
        font: 12px/1.4 ui-monospace, Menlo, Consolas, monospace;
        color: #b9c4ff;
        opacity: 0.9;
        max-width: 78vw;
        margin: 8px auto 0;
      }

      body.unlocked #qr-overlay {
        display: none !important;
      }
      body.unlocked #app {
        display: block !important;
      }

      body.unlocked #dark-overlay {
        opacity: 0 !important;
      }
    </style>
  </head>

  <body>
    <!-- OVERLAY: chỉ QR -->
    <div id="qr-overlay" aria-hidden="false">
      <div class="panel">
        <h2>Quét mã để mở “Love Tinh Cầu”</h2>
        <div id="qr-box"></div>
        <p id="qr-link"></p>
        <p style="font-size: 12px; opacity: 0.8">
          (Giữ nguyên bộ ảnh hiện tại trong liên kết)
        </p>
      </div>
    </div>

    <!-- ỨNG DỤNG CHÍNH (ẩn cho tới khi unlock) -->
    <div id="app" style="display: none">
      <div id="container">
        <div id="image-input-container">
          <label>Nhập link ảnh:</label><br />
          <textarea id="image-links" rows="4" cols="40"></textarea><br />
          <button id="generate-link">Copy link</button>
        </div>

        <button
          id="toggle-audio"
          class="text-white btn-audio-toggle"
          style="position: absolute; top: 10px; right: 10px; z-index: 999"
        >
          <i id="audio-icon" class="fa-solid fa-volume-xmark"></i>
        </button>

        <div id="landscape-warning">
          <div class="warning-content">
            <div class="rotate-icon"></div>
            <h1>Love</h1>
            <h1>Tinh Cầu</h1>
            <p style="font-size: 0.6em">Cậu hãy xoay ngang màn hình nha!</p>
            <p style="font-size: 0.6em">
              Nhớ chạm vào tinh cầu ở giữa để mở quà bí mật nha.
            </p>
            <p style="font-size: 0.6em">
              nếu bạn thấy hay thì like và comment mình sẽ hỗ trợ làm giúp cho
            </p>
            <p style="font-size: 0.6em">Love with Tiến Thương</p>
            <div class="stars-bg"></div>
          </div>
        </div>

        <div id="dark-overlay"></div>
        <div id="info"></div>
      </div>
    </div>

    <!-- CẤU HÌNH ẢNH -->
    <script>
      window.dataLove2Loveloom = {
        template: "galaxy",
        data: {
          keychain: {
            name: "Loveloom",
            phone: "Loveloom",
            address: "Loveloom",
          },
          ringTexts: ["My love"],
          images: [
            "./image/3.jpg",
            "./image/4.jpg",
            "./image/7.jpg",
            "./image/8.jpg",
            "./image/9.jpg",
            "./image/10.jpg",
            "./image/11.jpg",
            "./image/12.jpg",
            "./image/13.jpg",
            "./image/15.jpg",
            "./image/16.jpg",
            "./image/17.jpg",
            "./image/19.jpg",
            "./image/20.jpg",
            "./image/21.jpg",
          ],
        },
      };
    </script>

    <!-- QRCode lib -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <script>
      const SECRET_KEY = "mo-cua-tinh-cau";
      const PARAM_KEY = "key";

      function getImagesFromUrl() {
        const raw = new URLSearchParams(location.search).get("images");
        if (!raw) return null;
        return decodeURIComponent(raw)
          .split(",")
          .map((s) => s.trim())
          .filter(Boolean);
      }
      function getActiveImages() {
        return (
          getImagesFromUrl() || (window.dataLove2Loveloom?.data?.images ?? [])
        );
      }
      function buildShareUrlWithKey() {
        const { protocol, host, pathname } = location;
        const base = `${protocol}//${host}${pathname}`;
        const params = new URLSearchParams();
        params.set(PARAM_KEY, SECRET_KEY);
        const imgs = getActiveImages();
        if (imgs && imgs.length) params.set("images", imgs.join(",")); // KHÔNG encode lần 2
        return `${base}?${params.toString()}`;
      }
      function hasValidKey() {
        const params = new URLSearchParams(location.search);
        return params.get(PARAM_KEY) === SECRET_KEY;
      }

      (function gateByQR() {
        const app = document.getElementById("app");
        const overlay = document.getElementById("qr-overlay");
        const box = document.getElementById("qr-box");
        const linkEl = document.getElementById("qr-link");

        if (hasValidKey()) {
          document.body.classList.add("unlocked");
          overlay.setAttribute("aria-hidden", "true");
          overlay.style.display = "none";
          app.style.display = "block";
        } else {
          const url = buildShareUrlWithKey();
          linkEl.textContent = url;
          if (window.QRCode && box) {
            box.innerHTML = "";
            new QRCode(box, {
              text: url,
              width: 280,
              height: 280,
              colorDark: "#000",
              colorLight: "#fff",
              correctLevel: QRCode.CorrectLevel.H,
            });
          }
          app.style.display = "none";
          document.body.classList.remove("unlocked");
        }
      })();
    </script>
    <script>
      function tryPlayOnce() {
        const m = window.musicManager;
        if (!m || !m.audio) return;

        m.audio.muted = false;

        try {
          m.audio.load();
        } catch (_) {}

        m.audio
          .play()
          .then(() => {
            m.isPlaying = true;
            if (typeof m.updateUI === "function") m.updateUI();
          })
          .catch(() => {});
      }

      window.addEventListener("pointerdown", tryPlayOnce, { once: true });
      window.addEventListener("keydown", tryPlayOnce, { once: true });
    </script>

    <script src="./script.js"></script>
    <script type="module" src="./galaxy.js"></script>
  </body>
</html>
